<!DOCTYPE html>
<html>
    <head><meta charset="utf-8"/>
        <title>Std Navy Distribution List</title>

        <!-- Standard Navy Distribution List viewer.
            Tries to take the SNDL as distributed by the Navy and read it into a database
            that can be used from any modern web browser. You need to bring the SNDL, the app
            is supposed to do the rest.

            Copyright (c) 2020 Michael Pyne <michael.pyne@gmail.com>
        -->
<style>
.drop_hover {
    border: 2px solid green;
}

#output {
    margin-top: 2em;
    background: darkgray;
    color: white;
    font-family: monospace;
}

</style>
    </head>
    <body>
        <h3>SNDL Viewer</h3>

        <div id="file_drop_target">Drop SNDL.xlsx on me to load
            <input type='file' id='file_load_target'>Or enter a file to upload</input>.</div>

        <div id="content">
            <label>Enter a UIC to read: <input id="txt_uic_entry" placeholder="00076"></input></label>
            <button id="btn_read_uic">Read UIC</button>
        </div>

        <div id="output">
        </div>

        <script src="xlsx.full.min.js"></script>  <!-- Read Excel files -->
        <script src="levelgraph.min.js"></script> <!-- Graph database   -->
        <script>
            var g_workbook_data;
            var graph = levelgraph(level('uicdb'));

            // Ensure the db is already empty, it may be cached from previous page view
            graph.get({}, (err, results) => {
                for (const res of results) {
                    graph.del(res);
                }
            });

            // Logging function, also goes to the web page
            function output(txt) {
                const outputDiv = document.getElementById('output');
                outputDiv.innerHTML = txt;
                console.log(`output: ${txt}`);
            }

            function generateUnitGraph(db, units) {
                // Go through the list of units and turn them into nodes and
                // edges for the graph query
                for (const unit of units) {
                    if (!unit.PARENT_UIC || !unit.UIC) {
                        continue;
                    }

                    var triple = { subject: unit.PARENT_UIC, predicate: 'isic-of', object: unit.UIC };

                    db.put(triple, (err) => {
                        if(err) { console.error(err); }
                    });
                }
            }

            function handleFileLoad(files) {
                const file = files[0];
                const reader = new FileReader();

                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const worksheet = XLSX.read(data, { type: 'array' });
                    const firstSheetName = worksheet.SheetNames[0];

                    g_workbook_data = XLSX.utils.sheet_to_json(
                        worksheet.Sheets[firstSheetName],
                        // Shorter names for ease of use later
                        { header: [ 'SNDL', 'PLA', 'UIC', 'ACT_HEAD', 'ACT_TITLE',
                                    'ACT_LINE_3', 'ACT_LINE_4', 'ACT_LINE_5', 'CITY', 'STATE',
                                    'ZIP', 'PARENT_UIC', 'ISIC', 'ECHELON', 'ACT_CODE',
                                    'HOMEPORT', 'PDS', 'HP_EFF_DT',
                                  ]
                        }
                    );

                    output(`Workbook loaded, ${g_workbook_data.length} records`);

                    if (g_workbook_data.length > 0) {
                        generateUnitGraph(graph, g_workbook_data);
                    }
                }
                reader.readAsArrayBuffer(file);
            }

            function handleFileUpload(e) {
                console.log("Handling file upload");
                handleFileLoad(e.target.files);
            }

            function handleFileDrop(e) {
                e.stopPropagation(); e.preventDefault();

                console.log("Handling file DND");
                handleFileLoad(e.dataTransfer.files);

                let dropTarget = document.getElementById('file_drop_target');
                dropTarget.classList.remove('drop_hover');
            }

            function handleDragEnter(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';

                let dropTarget = document.getElementById('file_drop_target');
                dropTarget.classList.add('drop_hover');
            }

            function handleDragLeave(e) {
                e.preventDefault(); e.stopPropagation();

                let dropTarget = document.getElementById('file_drop_target');
                dropTarget.classList.remove('drop_hover');
            }

            let dropTarget = document.getElementById('file_drop_target');
            dropTarget.addEventListener('drop', handleFileDrop, false);

            dropTarget.addEventListener('dragenter', handleDragEnter, false);
            dropTarget.addEventListener('dragover',  handleDragEnter, false); // Same fn on purpose
            dropTarget.addEventListener('dragleave', handleDragLeave, false);

            let uploadTarget = document.getElementById('file_load_target');
            uploadTarget.addEventListener('change', handleFileUpload, false);

            let btn_UIC = document.getElementById('btn_read_uic');
            btn_UIC.addEventListener('click', () => {
                const uic_to_load = document.getElementById('txt_uic_entry').value;
                console.log(`Loading UIC ${uic_to_load}`);

                const obj = g_workbook_data.filter(e => e.UIC === uic_to_load)[0];

                if(obj) {
                    var out_string = `Found ${obj.ACT_TITLE}`;
                    console.dir(obj);

                    // Look for siblings: UICs that are 'isic-of' related to the same ISIC
                    // that isic-of points to us, by following the pointer back to the ISIC
                    graph.nav(obj.UIC).archIn('isic-of').archOut('isic-of').
                        solutions((err, results) => {
                            if(err) {
                                output(out_string);
                                console.error(err);
                                return;
                            }

                            if(results.length > 0) {
                                out_string = out_string + "<br/>Sibling units: <br/>";
                            }

                            for(const res of results) {
                                out_string = out_string + "<br/>";
                                out_string = out_string + `${res.x1}`;
                            }

                            output(out_string);
                        });
                } else {
                    output(`Found no result!`);
                }
            }, false);
        </script>
    </body>
</html>
